<?xml version="1.0" encoding="utf-8"?>
<!--
/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
**
** Copyright	2012 Dominik Pretzsch
**				2017 Gruppen it Security
**
** Author		Dominik Pretzsch
**				Nils Behlen
**
**    Licensed under the Apache License, Version 2.0 (the "License");
**    you may not use this file except in compliance with the License.
**    You may obtain a copy of the License at
**
**        http://www.apache.org/licenses/LICENSE-2.0
**
**    Unless required by applicable law or agreed to in writing, software
**    distributed under the License is distributed on an "AS IS" BASIS,
**    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
**    See the License for the specific language governing permissions and
**    limitations under the License.
**
** * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<?include $(sys.CURRENTDIR)\Config.wxi?>
	<Product Id="*" Language="1046" Name="$(var.ProductName)" Manufacturer="$(var.Publisher)" Version="$(var.Version)" UpgradeCode="cc1e3a9f-e37e-4ca9-bb97-28c711acb4ed">
		<Package Id="*" InstallerVersion="405" Compressed="yes" InstallScope="perMachine" InstallPrivileges="elevated" Manufacturer="$(var.Publisher)" Description="$(var.ProductName) $(var.Version) Instalação" />
		<MajorUpgrade AllowSameVersionUpgrades="yes"
					  AllowDowngrades="no"
					  MigrateFeatures="yes"
					  DowngradeErrorMessage="Uma versão mais recente do [ProductName] já está instalada!" />
		
		<Property Id="ARPURLINFOABOUT" Value="$(var.AppURLInfoAbout)" />
		<!-- Disable the modify/repair button in software explorer -->
		<Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
		<Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />
		<Condition Message="Você precisa ser administrador para instalar este produto.">
			Privileged
		</Condition>
		<!-- Custom action definitions -->
		<CustomAction Id="IsPrivileged" Error="Você precisa ser administrador para instalar este produto." />
		<CustomAction Id="PreventDowngrading" Error="Uma versão mais recente já está instalada." />
		<!-- END Custom action definitions-->
		<InstallExecuteSequence>
			<Custom Action="IsPrivileged" Before="AppSearch">
				Not Privileged
			</Custom>
		</InstallExecuteSequence>
		<!-- Icons etc -->
		<Icon Id="icon.ico" SourceFile="$(var.SolutionDir)icon.ico" />
		<Property Id="ARPPRODUCTICON" Value="icon.ico" />
		<Media Id="1" Cabinet="Sample.cab" EmbedCab="yes" DiskPrompt="DISK #1" />
		<Property Id="DiskPrompt" Value="$(var.ProductName) Setup [1]" />
		<!--<Binary Id='WiXCustomActions' SourceFile='$(var.WiXCustomActions.TargetPath)' />-->
		<Binary Id="InfoIcon" SourceFile="$(var.SolutionDir)info.ico" />
		<Binary Id="HelpIcon" SourceFile="$(var.SolutionDir)help.ico" />
		<Binary Id="ExclamIcon" SourceFile="$(var.SolutionDir)exclam.ico" />
		<!-- END  Icons etc -->
		<!-- END Preconditions and pre-setups -->

		<!-- PROPERTIES — Simplified: only ApiKey is asked during install -->
		<!-- ServerUrl is fixed; all other CP config is downloaded from the server -->
		<Property Id="SERVER_URL" Value="https://mfa.gruppen.com.br" />
		<Property Id="API_KEY">
			<RegistrySearch Id="SearchApiKey" Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="api_key" Win64="$(var.Win64)" Type="raw" />
		</Property>
		<Property Id="ENABLE_FILTER">
			<RegistrySearch Id="SearchEnableFilter" Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="enable_filter" Win64="$(var.Win64)" Type="raw" />
		</Property>
		<Property Id="DEBUG_LOG">
			<RegistrySearch Id="SearchDebugLog" Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="debug_log" Win64="$(var.Win64)" Type="raw" />
		</Property>

		<!-- Directory definitions -->
		<Directory Id="TARGETDIR" Name="SourceDir">
			<!-- Visual Studio C++ Redistributable -->
			<?if $(var.Configuration) = Debug ?>
			<?if $(var.Platform) = x64 ?>
			<Merge Id="VCRedist" SourceFile="$(var.SolutionDir)lib\merge\Microsoft_VC143_DebugCRT_x64.msm" DiskId="1" Language="0" />
			<?else ?>
			<Merge Id="VCRedist" SourceFile="$(var.SolutionDir)lib\merge\Microsoft_VC143_DebugCRT_x86.msm" DiskId="1" Language="0" />
			<?endif ?>
			<?else ?>
			<?if $(var.Platform) = x64 ?>
			<Merge Id="VCRedist" SourceFile="$(var.SolutionDir)lib\merge\Microsoft_VC143_CRT_x64.msm" DiskId="1" Language="0" />
			<?else ?>
			<Merge Id="VCRedist" SourceFile="$(var.SolutionDir)lib\merge\Microsoft_VC143_CRT_x86.msm" DiskId="1" Language="0" />
			<?endif ?>
			<?endif ?>
			<!-- END Visual Studio C++ Redistributable -->
			<!-- Directories/Components to be placed in ProgramFiles-folder -->
			<!-- Just remove the license file that was placed in the folder by versions < 3.2.0 -->
			<Directory Id="$(var.PlatformProgramFilesFolder)">
				<Directory Id="CompanyFolder" Name="$(var.Publisher)">
					<Directory Id="INSTALLFOLDER" Name="$(var.ProductFolderName)">
						<Component Id="DefaultFilesInProgrammFolder" Location="local" Guid="9d02dffe-1766-420c-97b5-755979b68205">
							<RemoveFile Id="RemoveInstallFiles" Name="*" On="install" />
							<RemoveFolder Id="RemoveInstallFolder" On="install" />
							<RemoveFolder Id="RemoveCompanyFolderIfEmpty" Directory="CompanyFolder" On="install" />
						</Component>
					</Directory>
					<!-- Agent Service subfolder under CompanyFolder -->
					<Directory Id="AGENTFOLDER" Name="GruppenMFA">
						<Component Id="AgentServiceExe" Location="local" Guid="B7F3A1E2-4D5C-6E7F-8A9B-0C1D2E3F4A5B">
							<File Id="AgentServiceFile" Name="GruppenMFA.AgentService.exe"
								  Source="$(var.SolutionDir)AgentService\publish\GruppenMFA.AgentService.exe"
								  KeyPath="yes" />
							<!-- Install and configure the Windows Service -->
							<ServiceInstall
								Id="AgentServiceInstall"
								Type="ownProcess"
								Name="GruppenMFAAgent"
								DisplayName="GruppenMFA Agent"
								Description="Serviço do Agente GruppenMFA - gerencia telemetria, configuração remota e proteção contra adulteração do GruppenMFA Credential Provider."
								Start="auto"
								Account="LocalSystem"
								ErrorControl="normal" />
							<ServiceControl
								Id="AgentServiceControl"
								Name="GruppenMFAAgent"
								Start="install"
								Stop="both"
								Remove="uninstall"
								Wait="yes" />
						</Component>
						<!-- Agent registry: store API key and config hash -->
						<Component Id="AgentRegistryComponent" Location="local" Guid="C8D4B2F3-5E6A-7F80-9B1C-2D3E4F5A6B7C">
							<RegistryKey Root="HKLM" Key="SOFTWARE\Gruppen IT\GruppenMFA-Agent" ForceCreateOnInstall="yes">
								<RegistryValue Name="api_key" Type="string" Value="[API_KEY]" KeyPath="yes" />
								<RegistryValue Name="config_hash" Type="string" Value="" />
								<RegistryValue Name="server_url" Type="string" Value="[SERVER_URL]" />
							</RegistryKey>
							<RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Gruppen IT\GruppenMFA-Agent" Action="removeOnUninstall" />
						</Component>
						<!-- ProgramData folder for agent data -->
						<Component Id="AgentDataFolder" Location="local" Guid="D9E5C3A4-6F7B-8091-AC2D-3E4F5A6B7C8D">
							<CreateFolder Directory="AGENTFOLDER" />
						</Component>
					</Directory>
				</Directory>
			</Directory>
			<!-- END Directories/Components to be placed in ProgramFiles-folder -->

			<!-- Directories/Components to be placed in ProgramData-folder (localization files)-->
			<Directory Id="$(var.PlatformProgramDataFolder)" Name="$(var.PlatformProgramDataFolder)">
				<Directory Id="PublisherFolder" Name ="$(var.Publisher)">
					<Directory Id="ProductFolderName" Name="$(var.ProductFolderName)">
						<Directory Id="locales" Name="locales" >
							<Component Id="LocalizationFilesInProgramDataFolder" Location="local" Guid="ddab0976-8d7c-476b-87c5-1318d39c65a1">
								<File Id="Localization_en"  Name="en.json" Source="$(var.SolutionDir)locales\en.json"  />
								<File Id="Localization_es"  Name="es.json" Source="$(var.SolutionDir)locales\es.json"  />
								<File Id="Localization_de"  Name="de.json" Source="$(var.SolutionDir)locales\de.json"  />
								<RemoveFile Id="RemoveLocalesFiles" Name="*" On="uninstall" />
								<RemoveFolder Id="RemoveLocalization" On="uninstall" />
								<RemoveFolder Id="RemovePublisherFolderIfEmpty" Directory="PublisherFolder" On="uninstall" />
							</Component>
						</Directory>
					</Directory>
				</Directory>
			</Directory>

			<!-- Directories/Components to be placed in System-folder -->
			<Directory Id="$(var.PlatformSystemFolder)">
				<!-- Core components -->
				<Component Location="local" Guid="9944eca5-ac62-4a0e-82fa-5ec243a56b0d" Transitive="yes">
					<Condition>1</Condition>
					<!-- Files -->
					<File Id="CredentialProvider" Name="$(var.CredentialProvider.TargetFileName)" Source="$(var.CredentialProvider.TargetPath)" KeyPath="yes" />
					<RemoveFile Id="RemoveCredentialProviderFiles" Name="$(var.CredentialProvider.TargetFileName)" On="uninstall" />
					<!-- END Files -->
					<!-- Registry -->
					<!-- Register the Provider -->
					<RegistryKey Root="HKCR" Key="CLSID\{$(var.ProviderRegistryGUID)}" ForceCreateOnInstall="yes">
						<RegistryValue Type="string" Value="$(var.CredentialProvider.TargetName)" />
						<RegistryKey Key="InprocServer32">
							<RegistryValue Type="string" Value="$(var.CredentialProvider.TargetFileName)" />
							<RegistryValue Name="ThreadingModel" Type="string" Value="Apartment" />
						</RegistryKey>
					</RegistryKey>
					<RemoveRegistryKey Root="HKCR" Key="CLSID\{$(var.ProviderRegistryGUID)}" Action="removeOnUninstall" />
					<RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Providers\{$(var.ProviderRegistryGUID)}" Type="string" Value="$(var.CredentialProvider.TargetName)" />
					<RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Providers\{$(var.ProviderRegistryGUID)}" Action="removeOnUninstall" />
					<!-- Configuration values — ServerUrl + ApiKey from installer, rest from server -->
					<RegistryKey Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" ForceCreateOnInstall="yes">
						<!-- ESSENTIAL — set by installer -->
						<RegistryValue Name="server_url" Type="string" Value="[SERVER_URL]" />
						<RegistryValue Name="api_key" Type="string" Value="[API_KEY]" />
						<RegistryValue Name="enable_filter" Type="string" Value="[ENABLE_FILTER]" />
						<RegistryValue Name="debug_log" Type="string" Value="[DEBUG_LOG]" />

						<!-- DEFAULTS — will be overridden by server config on first checkin -->
						<RegistryValue Name="hostname" Type="string" Value="" />
						<RegistryValue Name="path" Type="string" Value="" />
						<RegistryValue Name="custom_port" Type="string" Value="" />
						<RegistryValue Name="default_realm" Type="string" Value="" />

						<!-- MISC — sensible defaults -->
						<RegistryValue Name="header_accept_language" Type="string" Value="system" />
						<RegistryValue Name="localesPath" Type="string" Value="[$(var.PlatformProgramDataFolder)]$(var.Publisher)\$(var.ProductFolderName)\locales" />

						<!-- CONFIG TRACKING -->
						<RegistryValue Name="config_hash" Type="string" Value="" />
					</RegistryKey>
					<RemoveRegistryKey Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Action="removeOnUninstall" />
					<!-- END Configuration values -->
					<!-- END Registry -->
				</Component>
				<!-- END Core components -->

				<!-- ProviderFilter component -->
				<Component Location="local" Guid="a6d595a6-58b4-4541-8171-65f3f364b58c">
					<!-- Files -->
					<File Id="CredentialProviderFilter" Name="$(var.CredentialProviderFilter.TargetFileName)" Source="$(var.CredentialProviderFilter.TargetPath)" KeyPath="yes" />
					<RemoveFile Id="RemoveCredentialProviderFilterFiles" Name="$(var.CredentialProviderFilter.TargetFileName)" On="uninstall" />
					<!-- END Files -->
					<!-- Registry -->
					<RegistryKey Root="HKCR" Key="CLSID\{$(var.ProviderFilterRegistryGUID)}" ForceCreateOnInstall="yes">
						<RegistryValue Type="string" Value="$(var.CredentialProviderFilter.TargetName)" />
						<RegistryKey Key="InprocServer32">
							<RegistryValue Type="string" Value="$(var.CredentialProviderFilter.TargetFileName)" />
							<RegistryValue Name="ThreadingModel" Type="string" Value="Apartment" />
						</RegistryKey>
					</RegistryKey>
					<!-- END Registry -->
				</Component>
				<!-- END ProviderFilter component -->

				<!-- Activate ProviderFilter (InstallAsDefault) component -->
				<Component Id="ActivateCredentialProviderFilter" Location="local" Guid="ddc94b52-e7f2-4632-9f04-37f1b2b3c7a3">
					<RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Provider Filters\{$(var.ProviderFilterRegistryGUID)}" Type="string" Value="$(var.CredentialProviderFilter.TargetName)" KeyPath="yes" />
					<RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Provider Filters\{$(var.ProviderFilterRegistryGUID)}" Action="removeOnUninstall" />
				</Component>
				<!-- END Activate ProviderFilter component -->

				<!-- Remove old registry entries component -->
				<Component Id="RemoveObsoleteRegistryValues" Location="local" Guid="1D247BD9-A548-4904-A3E0-3C6F3234A111">
					<CreateFolder />
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="otp_link_text"/>
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="reset_link_text"/>
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="otp_fail_text"/>
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="otp_text"/>
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="two_step_hide_otp"/>
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="login_text"/>
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="webauthn_link_text"/>
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\$(var.Manufacturer)\$(var.SimpleProductName)" Name="webauthn_pin_hint"/>
				</Component>
				<!-- END remove old registry entries -->

				<!-- Register for Safe Mode (optional) -->
				<Component Id="RegisterForSafeMode" Location="local" Guid="49BB889F-6F08-48A9-9284-E0FF0F166F78">
					<Condition>REGISTER_FOR_SAFEMODE=1</Condition>
					<RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Providers" Name="ProhibitFallbacks" Type="integer" Value="1" />
					<RemoveRegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Providers" Name="ProhibitFallbacks"/>
				</Component>

				<!-- END register for Safe Mode -->
			</Directory>
			<!-- END Directories/Components to be placed in System-folder -->
		</Directory>
		<!-- END Directory definitions -->
		<!-- Feature definitions -->
		<Feature Id="Complete" Title="$(var.ProductName)" Description="Instalação completa" Display="expand" Level="1" ConfigurableDirectory="INSTALLFOLDER" AllowAdvertise="no" Absent="disallow" InstallDefault="local">
			<Feature Id="MainInstall" Title="Componentes principais" Description="Componentes principais do $(var.ProductName)" Level="1" AllowAdvertise="no" Absent="disallow" InstallDefault="local">
				<ComponentRef Id="CredentialProvider" />
				<ComponentRef Id="CredentialProviderFilter" />
				<ComponentRef Id="ActivateCredentialProviderFilter" />
				<ComponentRef Id="LocalizationFilesInProgramDataFolder"/>
				<ComponentRef Id="RemoveObsoleteRegistryValues"/>
				<ComponentRef Id="RegisterForSafeMode" />
			</Feature>
			<Feature Id="AgentService" Title="Serviço do Agente" Description="Serviço do Agente GruppenMFA para telemetria e configuração remota" Level="1" AllowAdvertise="no" Absent="disallow" InstallDefault="local">
				<ComponentRef Id="AgentServiceExe" />
				<ComponentRef Id="AgentRegistryComponent" />
				<ComponentRef Id="AgentDataFolder" />
			</Feature>
			<!-- These are installed anyway: -->
			<Feature Id="VCRedist" Title="Visual C++ Runtime" AllowAdvertise="no" Display="hidden" Level="1">
				<MergeRef Id="VCRedist" />
			</Feature>
			<ComponentRef Id="DefaultFilesInProgrammFolder" />
		</Feature>
		<!-- END Feature definitions -->
		<!-- WiX Configuration -->
		<WixVariable Id="WixUILicenseRtf" Value="$(var.SolutionDir)ApacheLicense.rtf" />
		<WixVariable Id="WixUIBannerBmp" Value="$(var.SolutionDir)WixUIBannerBmp.bmp" />
		<WixVariable Id="WixUIDialogBmp" Value="$(var.SolutionDir)WixUIDialogBmp.bmp" />
		<!-- END WiX Configuration -->
		<!-- UI Configuration — Simplified: single setup dialog for ServerUrl + ApiKey -->
		<UI Id="MyWixUI_FeatureTree">
			<UIRef Id="WixUI_FeatureTree" />
			<DialogRef Id="ServerDlg" />
			<!-- After license, go directly to connection setup (ServerUrl + ApiKey) -->
			<Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="ServerDlg">1</Publish>
			<Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ServerDlg" Order="1">NOT Installed OR (WixUI_InstallMode = "Change" AND USER_IS_ADMINISTRATOR = "1" )</Publish>
		</UI>
		<!-- END UI Configuration -->
	</Product>
</Wix>
